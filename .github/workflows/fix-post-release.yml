name: Manual Fix Release

on:
  workflow_dispatch:
    inputs:
      target_tag:
        description: 'Target Tag Name (e.g. v24.13.0)'
        required: true
        default: 'v24.13.0'
      source_run_id:
        description: 'Source Run ID with Artifacts'
        required: true
        default: '21507945723'

jobs:
  manual-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        type: [win, linux]

    steps:
      - name: Download NPM files
        uses: dawidd6/action-download-artifact@v6
        with:
          run_id: ${{ inputs.source_run_id }}
          path: libnode-npm
          name: libnode-npm

      - name: Download Bin files
        uses: dawidd6/action-download-artifact@v6
        with:
          run_id: ${{ inputs.source_run_id }}
          path: libnode-${{ matrix.type }}-x64-bin
          name: libnode-${{ matrix.type }}-x64-bin

      - name: Download PDB files (Windows)
        if: matrix.type == 'win'
        uses: dawidd6/action-download-artifact@v6
        with:
          run_id: ${{ inputs.source_run_id }}
          path: libnode-${{ matrix.type }}-x64-pdb
          name: libnode-${{ matrix.type }}-x64-pdb

      - name: Download SDK files
        uses: dawidd6/action-download-artifact@v6
        with:
          run_id: ${{ inputs.source_run_id }}
          path: libnode-${{ matrix.type }}-x64-sdk
          name: libnode-${{ matrix.type }}-x64-sdk

      - name: Pack Zip Files
        shell: bash
        run: |
          set -eux

          function pack_flat() {
            local dir=$1
            local zipfile=$2
            
            if [ -d "$dir" ]; then
              echo "Packing $dir into $zipfile (flat)..."
              pushd "$dir" > /dev/null
              zip -r "../$zipfile" .
              popd > /dev/null
            fi
          }

          pack_flat "libnode-npm" "libnode-npm.zip"
          pack_flat "libnode-${{ matrix.type }}-x64-bin" "libnode-${{ matrix.type }}-x64-bin.zip"
          pack_flat "libnode-${{ matrix.type }}-x64-sdk" "libnode-${{ matrix.type }}-x64-sdk.zip"

          if [ "${{ matrix.type }}" = "win" ]; then
            pack_flat "libnode-${{ matrix.type }}-x64-pdb" "libnode-${{ matrix.type }}-x64-pdb.zip"
          fi

      - name: Compute SHA256
        shell: bash
        run: |
          FILES="libnode-${{ matrix.type }}-x64-*.zip"
          [ "${{ matrix.type }}" = "win" ] && FILES="$FILES libnode-npm.zip"
          sha256sum $FILES > SHA256SUMS-${{ matrix.type }}

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.target_tag }}
          name: Release ${{ inputs.target_tag }}
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
          append_body: true
          body_path: SHA256SUMS-${{ matrix.type }}
          files: |
            libnode-${{ matrix.type }}-x64-*.zip
            libnode-npm.zip
            SHA256SUMS-${{ matrix.type }}
